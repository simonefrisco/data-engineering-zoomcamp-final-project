id: fetch-kaggle-dataset
namespace: prod
description: Save and Execute the flow

labels:
  env: prod

tasks:
  - id: wdir
    type: io.kestra.core.tasks.flows.WorkingDirectory
    tasks:
      # - id: SetKaggleAuth
      #   type: io.kestra.core.tasks.storages.LocalFiles
      #   inputs:
      #     kaggle.json: |
      #         {"username":"{{ secret('KAGGLE_USERNAME') }}" , "key":"{{ secret('KAGGLE_KEY') }}" }
      # - id: PrintJSON
      #   type : io.kestra.plugin.scripts.shell.Commands
      #   commands:
      #     - cat kaggle.json
      
      - id: fetchDataset
        type: io.kestra.plugin.scripts.python.Commands
        runner: PROCESS
        env:
          KAGGLE_USERNAME: "{{ secret('KAGGLE_USERNAME') }}"
          KAGGLE_KEY: "{{ secret('KAGGLE_KEY') }}"
        commands:
          - pip install kaggle
          - kaggle datasets download -d mkechinov/direct-messaging
        warningOnStdErr: false
  
      - id: printFiled
        type: io.kestra.plugin.scripts.python.Script
        runner: PROCESS
        script : |
          import os
          print(os.listdir(os.getcwd()))
      
      - id: uploadToS3
        type: io.kestra.plugin.aws.s3.Upload
        accessKeyId: "{{ secret('AWS_ACCESS_KEY') }}"
        secretKeyId: "{{ secret('AWS_SECRET_KEY') }}"
        region: "{{ secret('AWS_REGION') }}"
        from: "direct-messaging.zip"
        bucket: "kestra-datatalkclub"
        key: "download/direct-messaging.zip"